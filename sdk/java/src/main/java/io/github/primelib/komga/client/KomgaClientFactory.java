// WARNING: This file was generated by PrimeCodeGen. DO NOT EDIT.

package io.github.primelib.komga.client;

import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.MapperFeature;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.PropertyNamingStrategies;
import com.fasterxml.jackson.databind.SerializationFeature;
import com.fasterxml.jackson.databind.json.JsonMapper;
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;
import feign.Feign;
import feign.Logger;
import feign.jackson.JacksonDecoder;
import feign.jackson.JacksonEncoder;
import feign.micrometer.MicrometerCapability;
import feign.okhttp.OkHttpClient;
import feign.slf4j.Slf4jLogger;
import io.github.primelib.komga.client.client.KomgaClientApi;
import io.github.primelib.komga.client.client.KomgaClientConsumerApi;
import io.github.primelib.komga.client.client.KomgaClientannouncementControllerApi;
import io.github.primelib.komga.client.client.KomgaClientannouncementControllerConsumerApi;
import io.github.primelib.komga.client.client.KomgaClientbookControllerApi;
import io.github.primelib.komga.client.client.KomgaClientbookControllerConsumerApi;
import io.github.primelib.komga.client.client.KomgaClientclaimControllerApi;
import io.github.primelib.komga.client.client.KomgaClientclaimControllerConsumerApi;
import io.github.primelib.komga.client.client.KomgaClientfileSystemControllerApi;
import io.github.primelib.komga.client.client.KomgaClientfileSystemControllerConsumerApi;
import io.github.primelib.komga.client.client.KomgaClienthistoricalEventControllerApi;
import io.github.primelib.komga.client.client.KomgaClienthistoricalEventControllerConsumerApi;
import io.github.primelib.komga.client.client.KomgaClientlibraryControllerApi;
import io.github.primelib.komga.client.client.KomgaClientlibraryControllerConsumerApi;
import io.github.primelib.komga.client.client.KomgaClientloginControllerApi;
import io.github.primelib.komga.client.client.KomgaClientloginControllerConsumerApi;
import io.github.primelib.komga.client.client.KomgaClientoAuth2ControllerApi;
import io.github.primelib.komga.client.client.KomgaClientoAuth2ControllerConsumerApi;
import io.github.primelib.komga.client.client.KomgaClientopds2ControllerApi;
import io.github.primelib.komga.client.client.KomgaClientopds2ControllerConsumerApi;
import io.github.primelib.komga.client.client.KomgaClientopdsCommonControllerApi;
import io.github.primelib.komga.client.client.KomgaClientopdsCommonControllerConsumerApi;
import io.github.primelib.komga.client.client.KomgaClientopdsControllerApi;
import io.github.primelib.komga.client.client.KomgaClientopdsControllerConsumerApi;
import io.github.primelib.komga.client.client.KomgaClientpageHashControllerApi;
import io.github.primelib.komga.client.client.KomgaClientpageHashControllerConsumerApi;
import io.github.primelib.komga.client.client.KomgaClientreadListControllerApi;
import io.github.primelib.komga.client.client.KomgaClientreadListControllerConsumerApi;
import io.github.primelib.komga.client.client.KomgaClientreferentialControllerApi;
import io.github.primelib.komga.client.client.KomgaClientreferentialControllerConsumerApi;
import io.github.primelib.komga.client.client.KomgaClientseriesCollectionControllerApi;
import io.github.primelib.komga.client.client.KomgaClientseriesCollectionControllerConsumerApi;
import io.github.primelib.komga.client.client.KomgaClientseriesControllerApi;
import io.github.primelib.komga.client.client.KomgaClientseriesControllerConsumerApi;
import io.github.primelib.komga.client.client.KomgaClientsettingsControllerApi;
import io.github.primelib.komga.client.client.KomgaClientsettingsControllerConsumerApi;
import io.github.primelib.komga.client.client.KomgaClienttaskControllerApi;
import io.github.primelib.komga.client.client.KomgaClienttaskControllerConsumerApi;
import io.github.primelib.komga.client.client.KomgaClienttransientBooksControllerApi;
import io.github.primelib.komga.client.client.KomgaClienttransientBooksControllerConsumerApi;
import io.github.primelib.komga.client.client.KomgaClientuserControllerApi;
import io.github.primelib.komga.client.client.KomgaClientuserControllerConsumerApi;
import io.github.primelib.primecodegenlib.java.feign.common.capabilities.PrimeCapability;
import io.github.primelib.primecodegenlib.java.feign.common.interceptor.AuthInterceptor;
import java.net.InetSocketAddress;
import java.net.Proxy;
import java.util.function.Consumer;
import javax.annotation.processing.Generated;
import javax.net.ssl.SSLContext;
import javax.net.ssl.TrustManager;
import javax.net.ssl.X509TrustManager;
import lombok.AccessLevel;
import lombok.NoArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import okhttp3.Credentials;

@NoArgsConstructor(access = AccessLevel.PRIVATE, force = true)
@Slf4j
@Generated(value = "io.github.primelib.primecodegen")
public class KomgaClientFactory {
    public static <T> T create(Consumer<KomgaClientFactorySpec<T>> spec) {
        KomgaClientFactorySpec<T> config = new KomgaClientFactorySpec<>(spec);

        if (config.api().isInterface()) {
            return buildClient(spec);
        }
        if (config.api() == KomgaClientConsumerApi.class) {
            return (T) KomgaClientFactory.buildConsumerClient(KomgaClientConsumerApi.class, KomgaClientApi.class, (KomgaClientFactorySpec<KomgaClientConsumerApi>) config);
        }
        if (config.api() == KomgaClientannouncementControllerConsumerApi.class) {
            return (T) KomgaClientFactory.buildConsumerClient(KomgaClientannouncementControllerConsumerApi.class, KomgaClientannouncementControllerApi.class, (KomgaClientFactorySpec<KomgaClientannouncementControllerConsumerApi>) config);
        }
        if (config.api() == KomgaClientbookControllerConsumerApi.class) {
            return (T) KomgaClientFactory.buildConsumerClient(KomgaClientbookControllerConsumerApi.class, KomgaClientbookControllerApi.class, (KomgaClientFactorySpec<KomgaClientbookControllerConsumerApi>) config);
        }
        if (config.api() == KomgaClientclaimControllerConsumerApi.class) {
            return (T) KomgaClientFactory.buildConsumerClient(KomgaClientclaimControllerConsumerApi.class, KomgaClientclaimControllerApi.class, (KomgaClientFactorySpec<KomgaClientclaimControllerConsumerApi>) config);
        }
        if (config.api() == KomgaClientfileSystemControllerConsumerApi.class) {
            return (T) KomgaClientFactory.buildConsumerClient(KomgaClientfileSystemControllerConsumerApi.class, KomgaClientfileSystemControllerApi.class, (KomgaClientFactorySpec<KomgaClientfileSystemControllerConsumerApi>) config);
        }
        if (config.api() == KomgaClienthistoricalEventControllerConsumerApi.class) {
            return (T) KomgaClientFactory.buildConsumerClient(KomgaClienthistoricalEventControllerConsumerApi.class, KomgaClienthistoricalEventControllerApi.class, (KomgaClientFactorySpec<KomgaClienthistoricalEventControllerConsumerApi>) config);
        }
        if (config.api() == KomgaClientlibraryControllerConsumerApi.class) {
            return (T) KomgaClientFactory.buildConsumerClient(KomgaClientlibraryControllerConsumerApi.class, KomgaClientlibraryControllerApi.class, (KomgaClientFactorySpec<KomgaClientlibraryControllerConsumerApi>) config);
        }
        if (config.api() == KomgaClientloginControllerConsumerApi.class) {
            return (T) KomgaClientFactory.buildConsumerClient(KomgaClientloginControllerConsumerApi.class, KomgaClientloginControllerApi.class, (KomgaClientFactorySpec<KomgaClientloginControllerConsumerApi>) config);
        }
        if (config.api() == KomgaClientoAuth2ControllerConsumerApi.class) {
            return (T) KomgaClientFactory.buildConsumerClient(KomgaClientoAuth2ControllerConsumerApi.class, KomgaClientoAuth2ControllerApi.class, (KomgaClientFactorySpec<KomgaClientoAuth2ControllerConsumerApi>) config);
        }
        if (config.api() == KomgaClientopds2ControllerConsumerApi.class) {
            return (T) KomgaClientFactory.buildConsumerClient(KomgaClientopds2ControllerConsumerApi.class, KomgaClientopds2ControllerApi.class, (KomgaClientFactorySpec<KomgaClientopds2ControllerConsumerApi>) config);
        }
        if (config.api() == KomgaClientopdsCommonControllerConsumerApi.class) {
            return (T) KomgaClientFactory.buildConsumerClient(KomgaClientopdsCommonControllerConsumerApi.class, KomgaClientopdsCommonControllerApi.class, (KomgaClientFactorySpec<KomgaClientopdsCommonControllerConsumerApi>) config);
        }
        if (config.api() == KomgaClientopdsControllerConsumerApi.class) {
            return (T) KomgaClientFactory.buildConsumerClient(KomgaClientopdsControllerConsumerApi.class, KomgaClientopdsControllerApi.class, (KomgaClientFactorySpec<KomgaClientopdsControllerConsumerApi>) config);
        }
        if (config.api() == KomgaClientpageHashControllerConsumerApi.class) {
            return (T) KomgaClientFactory.buildConsumerClient(KomgaClientpageHashControllerConsumerApi.class, KomgaClientpageHashControllerApi.class, (KomgaClientFactorySpec<KomgaClientpageHashControllerConsumerApi>) config);
        }
        if (config.api() == KomgaClientreadListControllerConsumerApi.class) {
            return (T) KomgaClientFactory.buildConsumerClient(KomgaClientreadListControllerConsumerApi.class, KomgaClientreadListControllerApi.class, (KomgaClientFactorySpec<KomgaClientreadListControllerConsumerApi>) config);
        }
        if (config.api() == KomgaClientreferentialControllerConsumerApi.class) {
            return (T) KomgaClientFactory.buildConsumerClient(KomgaClientreferentialControllerConsumerApi.class, KomgaClientreferentialControllerApi.class, (KomgaClientFactorySpec<KomgaClientreferentialControllerConsumerApi>) config);
        }
        if (config.api() == KomgaClientseriesCollectionControllerConsumerApi.class) {
            return (T) KomgaClientFactory.buildConsumerClient(KomgaClientseriesCollectionControllerConsumerApi.class, KomgaClientseriesCollectionControllerApi.class, (KomgaClientFactorySpec<KomgaClientseriesCollectionControllerConsumerApi>) config);
        }
        if (config.api() == KomgaClientseriesControllerConsumerApi.class) {
            return (T) KomgaClientFactory.buildConsumerClient(KomgaClientseriesControllerConsumerApi.class, KomgaClientseriesControllerApi.class, (KomgaClientFactorySpec<KomgaClientseriesControllerConsumerApi>) config);
        }
        if (config.api() == KomgaClientsettingsControllerConsumerApi.class) {
            return (T) KomgaClientFactory.buildConsumerClient(KomgaClientsettingsControllerConsumerApi.class, KomgaClientsettingsControllerApi.class, (KomgaClientFactorySpec<KomgaClientsettingsControllerConsumerApi>) config);
        }
        if (config.api() == KomgaClienttaskControllerConsumerApi.class) {
            return (T) KomgaClientFactory.buildConsumerClient(KomgaClienttaskControllerConsumerApi.class, KomgaClienttaskControllerApi.class, (KomgaClientFactorySpec<KomgaClienttaskControllerConsumerApi>) config);
        }
        if (config.api() == KomgaClienttransientBooksControllerConsumerApi.class) {
            return (T) KomgaClientFactory.buildConsumerClient(KomgaClienttransientBooksControllerConsumerApi.class, KomgaClienttransientBooksControllerApi.class, (KomgaClientFactorySpec<KomgaClienttransientBooksControllerConsumerApi>) config);
        }
        if (config.api() == KomgaClientuserControllerConsumerApi.class) {
            return (T) KomgaClientFactory.buildConsumerClient(KomgaClientuserControllerConsumerApi.class, KomgaClientuserControllerApi.class, (KomgaClientFactorySpec<KomgaClientuserControllerConsumerApi>) config);
        }

        throw new IllegalArgumentException("api must be an compatible interface or consumer class");
    }

    public static KomgaClientApi create() {
        return create(spec -> spec.api(KomgaClientApi.class));
    }

    private static <T, U> T buildConsumerClient(Class<T> consumerApiClass, Class<U> apiClass, KomgaClientFactorySpec<T> config) {
        try {
            U api = buildClient(s -> {
                s.api(apiClass);
                s.applySpec(config);
            });
            return consumerApiClass.getConstructor(apiClass).newInstance(api);
        } catch (Exception ex) {
            throw new IllegalArgumentException("API must have a constructor with one parameter of type " + apiClass.getSimpleName(), ex);
        }
    }

    private static <T> T buildClient(Consumer<KomgaClientFactorySpec<T>> spec) {
        KomgaClientFactorySpec<T> config = new KomgaClientFactorySpec<>(spec);

        // http client
        okhttp3.OkHttpClient.Builder clientBuilder = new okhttp3.OkHttpClient.Builder();
        if (config.proxy() != null && config.proxy().type() != Proxy.Type.DIRECT) {
            clientBuilder.proxy(new Proxy(config.proxy().type(), new InetSocketAddress(config.proxy().host(), config.proxy().port())));
            if (config.proxy().username() != null || config.proxy().password() != null) {
                clientBuilder.proxyAuthenticator((route, response) -> {
                    return response.request().newBuilder()
                            .header("Proxy-Authorization", Credentials.basic(config.proxy().username(), new String(config.proxy().password())))
                            .build();
                });
            }
        }

        // insecure
        if (config.insecure()) {
            try {
                TrustManager[] trustAllCerts = new TrustManager[]{
                    new X509TrustManager() {
                        @Override
                        public void checkClientTrusted(java.security.cert.X509Certificate[] chain, String authType) {}

                        @Override
                        public void checkServerTrusted(java.security.cert.X509Certificate[] chain, String authType) {}

                        @Override
                        public java.security.cert.X509Certificate[] getAcceptedIssuers() {
                            return new java.security.cert.X509Certificate[]{};
                        }
                    }
                };

                SSLContext sslContext = SSLContext.getInstance("SSL");
                sslContext.init(null, trustAllCerts, new java.security.SecureRandom());

                clientBuilder.hostnameVerifier((hostname, session) -> true);
                clientBuilder.sslSocketFactory(sslContext.getSocketFactory(), (X509TrustManager) trustAllCerts[0]);
            } catch (Exception ex) {
                throw new RuntimeException("failed to configure insecure mode", ex);
            }
        }

        // objectMapper
        JsonMapper.Builder objectMapperBuilder = JsonMapper.builder()
                .enable(MapperFeature.ACCEPT_CASE_INSENSITIVE_ENUMS)
                .enable(DeserializationFeature.READ_UNKNOWN_ENUM_VALUES_USING_DEFAULT_VALUE)
                .disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES)
                .propertyNamingStrategy(PropertyNamingStrategies.LOWER_CAMEL_CASE)
                .configure(SerializationFeature.FAIL_ON_EMPTY_BEANS, false)
                .addModule(new JavaTimeModule());
        config.extensions().forEach(extension -> extension.customizeObjectMapper(objectMapperBuilder));
        ObjectMapper objectMapper = objectMapperBuilder.build();

        // builder
        return Feign.builder()
                .client(new OkHttpClient(clientBuilder.build()))
                .encoder(new JacksonEncoder(objectMapper))
                .decoder(new JacksonDecoder(objectMapper))
                .logger(new Slf4jLogger())
                .logLevel(Logger.Level.valueOf(config.logLevel().toUpperCase()))
                .addCapability(new MicrometerCapability(config.meterRegistry()))
                .addCapability(new PrimeCapability(config.backendName(), config.extensions()))
                .requestInterceptor(new AuthInterceptor(config.auth()))
                .decodeVoid()
                .target(config.api(), config.baseUrl());
    }
}
